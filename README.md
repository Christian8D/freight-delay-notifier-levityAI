
<!-- <div align="center"style="text-align: center;">
<img src="https://christianc.dev/wp-content/uploads/2025/05/Screenshot-2025-05-10-at-19.25.12.png" width="400" alt="Temporal Logo"  style="display: block; margin: 0 auto;"  />
<img src="https://christianc.dev/wp-content/uploads/2025/05/LevityAi.png" width="300" alt="Temporal Logo"  style="display: block; margin: 0 auto;"  />


</div> -->

<div align="center" style="text-align: center;">
   <img src="https://christianc.dev/wp-content/uploads/2024/11/Screen-Shot-2024-11-18-at-9.28.15-PM.svg" width="800" alt="Overlay Image" style="position: absolute; top: 0; left: 50%; transform: translateX(50%);" />

<img src="https://framerusercontent.com/images/qFTSfYBH5aoyhySaMO3zaAfVo.png" width="200" alt="Background Image" style="display: block; width: 40%;" /> 
 
</div>

# <div align="center" style="text-align: center;"> üöö <br> Freight Delay Notification System Exercise <br> Engineering Edition </div>

An end‚Äëto‚Äëend TypeScript¬†/ Temporal demo that monitors live road traffic for predefined freight routes and notifies customers by email when shipments are delayed.

üéØ Objective
Create an app (in TypeScript) to monitor traffic delays on a freight delivery route and notify a customer if a significant delay occurs.
The goal of this exercise is to assess your ability to work with APIs, handle data transformations, and build a multi-step workflow using Temporal (and their TypeScript SDK).

üìò Scenario
Imagine you‚Äôre tasked with setting up a notification system for delayed freight deliveries. You will use Temporal to create a workflow that:

Checks traffic conditions on a delivery route

Calculates potential delays

Uses an AI API to generate a customized message if a delay exceeds a specified threshold

Sends a notification to a customer about the delay

And finalizes workflow on delivery (Simulated - Bonus) 

App Config behaviour adjustmen panel ready (Bonus)

Powered by:

* **Google¬†Maps Directions API** ‚Äì real‚Äëtime ETA and traffic data
* **OpenAI¬†GPT‚Äë4o-mini** ‚Äì generates polite, context‚Äërich customer messages
* **SendGrid** ‚Äì delivers the email
* **Temporal** ‚Äì orchestrates long‚Äërunning workflows, polling, retries and timing


## Table of contents

1. [Architecture](#architecture)
2. [Repository layout](#repository-layout)
3. [Getting started](#getting-started)
4. [Configuration](#configuration)
5. [Scripts¬†&¬†tasks](#scripts)
6. [Troubleshooting](#troubleshooting)

## Architecture

```mermaid
sequenceDiagram
    participant CLI as index.ts (CLI)
    participant WF  as monitorWorkflow (Workflow)
    participant Maps as Google Maps API
    participant OpenAI as OpenAI (GPT Message Generator)
    participant SendGrid as SendGrid (Notification Service)

    %%‚Äî Bootstrap ‚Äî%%
    CLI->>WF: Start workflow <br/>(route, threshold GLOBAL_THRESHOLD=-25 m, taskCompletedTimer, customer)
    activate WF

    %%‚Äî Main polling loop ‚Äî%%
    loop Every 30 s (POLL_INTERVAL_MIN = 0.5)
        %% 1Ô∏è‚É£ Get live traffic
        WF->>Maps: Request ETA with traffic
        Maps-->>WF: ETA + delayMinutes

        %% 2Ô∏è‚É£ Simulate delivery completion
        alt taskCompletedTimer elapsed
            WF-->>CLI: Finish workflow ‚úì
            deactivate WF
        end

        %% 3Ô∏è‚É£ Otherwise, check delay status
        alt Delay ‚â• threshold (GLOBAL_THRESHOLD=-25 m)<br/>OR worsened by DELTA_JUMP_MIN= +10 m<br/>OR no update in MAX_QUIET_MIN=‚â•60 m
            WF->>OpenAI: Generate email (route, delayMinutes)
            OpenAI-->>WF: Return message

            WF->>SendGrid: Send email to customer
            SendGrid-->>WF: Confirm delivery
        else Delay within acceptable range
            WF-->>WF: Skip notification
        end
    end

```

Each job (route) runs as its own workflow instance until completion and follows the loop above. Temporal makes the polling and retry logic fault‚Äëtolerant and horizontally scalable.

[‚¨Ü Back to top](#table-of-contents)


## Repository layout

```text
‚îú‚îÄ‚îÄ launch.json              
‚îú‚îÄ‚îÄ package-lock.json         
‚îú‚îÄ‚îÄ package.json              
‚îú‚îÄ‚îÄ README.md                 # Project documentation
‚îú‚îÄ‚îÄ src
‚îÇ   ‚îú‚îÄ‚îÄ config.ts             # Config for tuning thresholds, origins, etc.
‚îÇ   ‚îú‚îÄ‚îÄ index.ts              # Entry point: schedules workflows
‚îÇ   ‚îú‚îÄ‚îÄ worker.ts             # Worker registration and runner
‚îÇ   ‚îú‚îÄ‚îÄ test/                 # Testing modules
‚îÇ   ‚îú‚îÄ‚îÄ activities/           # OpenAI, SendGrid calls, Google Maps
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ai.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ notifications.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ traffic.ts        
‚îÇ   ‚îî‚îÄ‚îÄ workflows/            # Temporal workflow logic
‚îÇ       ‚îú‚îÄ‚îÄ delayNotifications.ts
‚îÇ       ‚îú‚îÄ‚îÄ index.ts
‚îÇ       ‚îî‚îÄ‚îÄ monitorWorkflow.ts
‚îú‚îÄ‚îÄ tsconfig.json             # TypeScript configuration
‚îî‚îÄ‚îÄ your_temporal.db          # SQLite DB used by Temporal server
```

[‚¨Ü Back to top](#table-of-contents)

## Getting started

\###¬†1.¬†Prerequisites

* Node.js¬†>=¬†18
* A running Temporal server (e.g., `docker‚Äëcompose up` from the official samples)
* Alternatively, you can run brew install temporal and start the Temporal server locally (for testing and development purposes only).
* API keys: Google¬†Maps, OpenAI, SendGrid

\###¬†2.¬†Install

```bash
git clone https://github.com/Christian8D/freight-delay-notifier-levityAI.git
cd freight-delay-notifier
npm install
```

\###¬†3.¬†Environment variables Create a `.env` file at the repo root:

```bash
OPENAI_API_KEY=<your key>
SENDGRID_API_KEY=<your key>
GOOGLE_MAPS_API_KEY=<your key>
```
\###¬†4.¬†üëâ Install via Homebrew (Mac / Linux):

```bash
brew install temporal
temporal --version
temporal server start-dev
```
\### 5.¬†You should see logs like:

```bash
Temporal server started.
Namespace default registered.
```

\###¬†6.¬†Build¬†& run

```bash
# compile TypeScript
npm run build

# start worker + schedule workflows
npm start
```

Logs will show one worker poller and one workflow scheduled per entry in `src/config.ts`.

[‚¨Ü Back to top](#table-of-contents)

## Configuration

## `src/config.ts`

The `config.ts` file is the **central place** to define all key parameters, routes, and customers for the freight monitoring system. You can customize it without touching any other part of the codebase.

---


* `TASK_QUEUE`: The Temporal **queue name** where workers listen for tasks. Default: `'FreightMonitorQueue'`.


### üö¶ Tuning knobs

| Constant            | Description                                                                                                                 | Default |
| ------------------- | --------------------------------------------------------------------------------------------------------------------------- | ------- |
| `TASK_QUEUE`  | The Temporal **queue name** where workers listen for tasks. |`'FreightMonitorQueue'`.  |
| `GLOBAL_THRESHOLD`  | The minimum delay (in minutes) before sending an alert. **‚ö†Ô∏è Important:** Remove the `-` sign to track real traffic delays. | `30`   |
| `DELTA_JUMP_MIN`    | The extra delay (minutes) needed to consider the delay as ‚Äúworsened‚Äù and send an updated notification.                      | `15`     |
| `MAX_QUIET_MIN`     | The maximum time (minutes) the workflow waits before sending a fresh update, even if the delay hasn't changed much.         | `60`     |
| `CLEAR_MARGIN_MIN`  | When delays drop below `(threshold - this margin)`, the delay is considered ‚Äúcleared.‚Äù                                      | `30`     |
| `POLL_INTERVAL_MIN` | How often (in minutes) the system polls Google Maps for new traffic data.                                                   | `.5` 30s    |

---

[‚¨Ü Back to top](#table-of-contents)

### üó∫ Routes & Customers

Example predefined **origins**, **destinations**, and customers:

| Job ID | Origin Address                           | Destination | Customer Name | Customer Email                                                  |
| ------ | ---------------------------------------- | ----------- | ------------- | --------------------------------------------------------------- |
| 1      | Neuschwansteinstra√üe 20, 87645 Schwangau | Stuttgart   | Christian C   | [hire@christianc.dev](mailto:hire@christianc.dev) |
| 2      | Bielkenhagen 10, 18439 Stralsund         | Munich      | Manny M       | [hire@christianc.dev](mailto:hire@christianc.dev) |
| 3      | Unter den Linden 10, 10117 Berlin        | Berlin      | Leo M         | [hire@christianc.dev](mailto:hire@christianc.dev) |

To **add new routes, origins and custumers**, simply append to the `src/config.ts` array:

```ts

export const Origin_4 = 'New Origin 4';
export const Destination_4 = 'New Destination 4';
export const Customer_4 = { name: 'Jon Doe', email: 'JonDoe@example.com' };



 {
    job_id: 4,
    route: {
        origin: Origin_4,
        destination: Destination_4,
        },
    threshold: GLOBAL_THRESHOLD,
    customer: Customer_4,
    },
```


---

‚úÖ **Pro Tip:**

* To **disable a job**, simply comment it out in `ROUTE_CONFIGS`.
* To **adjust sensitivity**, change `GLOBAL_THRESHOLD` and rerun your workflows.

This file is designed for **easy customization**‚Äîno code elsewhere needs changes when you modify routes, customers, or thresholds.

* **.env** for secret keys

[‚¨Ü Back to top](#table-of-contents)

## Scripts

`package.json` exposes handy aliases:

* `npm run worker` ‚Äì start just the worker
* `npm run start` ‚Äì worker + job scheduler
* `npm run test:traffic` / `test:ai` / `test:notif` ‚Äì run individual module tests
* `npm run test:workflow` ‚Äì run Temporal workflow tests (uses¬†@temporalio/testing)

[‚¨Ü Back to top](#table-of-contents)

## Troubleshooting

* **No emails arriving?**¬†Check SendGrid dashboard activity and verify `FROM_EMAIL` in `notifications.ts`.
* \`\` errors¬†‚Äì ensure `.env` is loaded or environment is passed to your process manager.
* **Workflow "already started"** messages on restart are expected and benign¬†‚Äì each job reuses its `workflowId`.

## License

MIT ¬©¬†2025¬†Christian Cosio